<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æœè¯ç»Ÿè®¡ - æ™ºä¼´é“¶é¾„</title>
    <style>
        body { display: flex; margin: 0; font-family: 'Segoe UI', sans-serif; background: #f4f7f9; height: 100vh; }
        
        /* ä¾§è¾¹æ æ ·å¼ï¼šä¸é¦–é¡µä¿æŒç»å¯¹ä¸€è‡´ */
        .sidebar { width: 240px; background: #001529; color: white; display: flex; flex-direction: column; }
        .sidebar h2 { padding: 20px; text-align: center; border-bottom: 1px solid #1f2d3d; margin: 0; }
        .menu-item { padding: 15px 25px; color: #a6adb4; cursor: pointer; transition: 0.3s; }
        .menu-item:hover, .active-menu { color: white !important; background: #1890ff !important; }
        
        .main { flex: 1; padding: 25px; overflow-y: auto; }
        
        /* è¾¾æˆç‡å¡ç‰‡ */
        .rate-card { background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .progress-container { width: 100%; background: #eee; border-radius: 10px; height: 20px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #1890ff, #52c41a); width: 0%; transition: width 0.8s ease; }
        
        /* è¡¨æ ¼æ ·å¼ */
        .med-list { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #fafafa; padding: 16px; text-align: left; border-bottom: 2px solid #f0f0f0; }
        td { padding: 16px; border-bottom: 1px solid #f0f0f0; }
        
        .status-tag { padding: 4px 10px; border-radius: 4px; font-size: 12px; }
        .status-done { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
        .status-pending { background: #fff7e6; color: #faad14; border: 1px solid #ffe7ba; }
        button { padding: 6px 12px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>æ™ºä¼´é“¶é¾„</h2>
        <div class="menu-item" onclick="location.href='home.html'">ğŸ  é¦–é¡µæ¦‚è§ˆ</div>
        <div class="menu-item" onclick="location.href='health-add.html'">ğŸ“ å¥åº·è®°å½•å½•å…¥</div>
        <div class="menu-item active-menu" onclick="location.href='medication.html'">ğŸ’Š æœè¯è®°å½•ç»Ÿè®¡</div>
        <div class="menu-item" onclick="location.href='alerts.html'">âš ï¸ å¼‚å¸¸æé†’ä¸­å¿ƒ</div>
        <div class="menu-item" style="margin-top: auto; border-top: 1px solid #1f2d3d;" onclick="localStorage.clear(); location.href='login.html'">ğŸšª é€€å‡ºç™»å½•</div>
    </div>

    <div class="main">
        <h3>æœè¯è¾¾æˆç‡ç›‘æµ‹</h3>
        <div class="rate-card">
            <div>ä»Šæ—¥æœè¯å®Œæˆè¿›åº¦ï¼š<b id="rateText" style="font-size: 20px; color: #1890ff;">0%</b></div>
            <div class="progress-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <small style="color: #888;">* ç»Ÿè®¡ç»“æœåŸºäºä»Šæ—¥è®¡åˆ’è¯é‡ä¸å·²ç¡®è®¤è®°å½•</small>
        </div>

        <div class="med-list">
            <h4>ä»Šæ—¥æœè¯è¯¦æƒ…æ¸…å•</h4>
            <table>
                <thead>
                    <tr>
                        <th>è¯å“åç§°</th>
                        <th>æœç”¨å‰‚é‡</th>
                        <th>è®¡åˆ’æ—¶é—´</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="medTableBody">
                    <tr><td colspan="5" style="text-align:center;">æ•°æ®åŒæ­¥ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        window.onload = async () => {
            const childId = localStorage.getItem('userId');
            if (!childId) {
                window.location.href = 'login.html';
                return;
            }
            loadMedData(childId);
        };

        async function loadMedData(childId) {
            try {
                // 1. è·å–å…³è”è€äºº
                const relRes = await fetch(`http://localhost:8080/api/relation/elder/list?childId=${childId}`);
                const relData = await relRes.json();
                
                if (relData.code === 200 && relData.data.length > 0) {
                    const elderId = relData.data[0].userId || relData.data[0].elderId;
                    
                    // 2. è·å–æœè¯è®°å½•
                    const res = await fetch(`http://localhost:8080/api/medication/list?userId=${elderId}`);
                    const result = await res.json();
                    
                    if (result.code === 200) {
                        renderMedTable(result.data);
                        updateProgress(result.data);
                    }
                }
            } catch (error) {
                console.error("åŠ è½½å¤±è´¥:", error);
                document.getElementById('medTableBody').innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">æ— æ³•è¿æ¥æœåŠ¡å™¨</td></tr>';
            }
        }

        function renderMedTable(data) {
            const tbody = document.getElementById('medTableBody');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ä»Šæ—¥æš‚æ— æœè¯è®¡åˆ’</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            data.forEach(item => {
                const isDone = item.status === 1; 
                const row = `
                    <tr>
                        <td><b>${item.medName}</b></td>
                        <td>${item.dosage}</td>
                        <td>${item.planTime || 'æœªè®¾ç½®'}</td>
                        <td>
                            <span class="status-tag ${isDone ? 'status-done' : 'status-pending'}">
                                ${isDone ? 'å·²æœè¯' : 'å¾…æœç”¨'}
                            </span>
                        </td>
                        <td>
                            ${isDone ? '<span style="color:#ccc">å®Œæˆ</span>' : `<button onclick="confirmMed(${item.recordId})">ç¡®è®¤æœç”¨</button>`}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateProgress(data) {
            if (!data || data.length === 0) return;
            const doneCount = data.filter(i => i.status === 1).length;
            const rate = Math.round((doneCount / data.length) * 100);
            
            document.getElementById('progressBar').style.width = rate + '%';
            document.getElementById('rateText').innerText = rate + '%';
        }

        async function confirmMed(recordId) {
            if(confirm("ç¡®å®šå·²æœç”¨è¯¥è¯ç‰©å—ï¼Ÿ")) {
                // è¿™é‡Œå¯¹æ¥æ›´æ–°æ¥å£ï¼Œå®Œæˆåé‡æ–°åŠ è½½
                alert("ç¡®è®¤æˆåŠŸï¼");
                // location.reload(); 
            }
        }
    </script>
</body>
</html>